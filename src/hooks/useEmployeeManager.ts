import { useState, useEffect } from 'react';
import { type Employee } from './useEmployeeSearch';
import { toast } from './use-toast';

const STORAGE_KEY = 'torp_employees';

// Fun√ß√£o para gerar ID √∫nico
const generateId = () => {
  return Date.now().toString(36) + Math.random().toString(36).substr(2);
};

// Dados padr√£o dos funcion√°rios
const DEFAULT_EMPLOYEES: Employee[] = [
  // FUNCION√ÅRIO TESTE - DEMONSTRA√á√ÉO PARA DIRETORIA
  { 
    id: generateId(),
    name: "Jo√£o Silva (TESTE - Demonstra√ß√£o)", 
    extension: "4999", 
    email: "joao.teste@torp.ind.br", 
    department: "TI", 
    lunchTime: "07:00-16:00" 
  },
  
  // GENTE E GEST√ÉO
  { id: generateId(), name: "Fl√°via (Diretora)", extension: "4723", email: "xxx", department: "Gente e Gest√£o" },
  { id: generateId(), name: "Bruno (RH)", extension: "4727", email: "bruno.oliveira@torp.ind.br", department: "Gente e Gest√£o", lunchTime: "12:00-13:00" },
  { id: generateId(), name: "Fabiane (Enfermagem)", extension: "4805", email: "fabiane.lourenco@torp.ind.br", department: "Gente e Gest√£o", lunchTime: "12:00-13:00" },
  
  // SALAS
  { id: generateId(), name: "Sala de Reuni√µes", extension: "4724", email: "xxx", department: "Salas" },
  
  // ADMINISTRATIVO
  { id: generateId(), name: "Ediane (Financeiro)", extension: "4713", email: "ediane.costa@torp.ind.br", department: "Administrativo", lunchTime: "12:00-13:00" },
  { id: generateId(), name: "Michele (Fiscal)", extension: "4729", email: "fiscal@torp.ind.br", department: "Administrativo", lunchTime: "11:00-12:00" },
  { id: generateId(), name: "Jussara In√°cio (Recep√ß√£o)", extension: "4701", email: "jussara.inacio@torp.ind.br", department: "Administrativo", lunchTime: "11:30-13:00" },
  { id: generateId(), name: "Fernanda (Faturamento)", extension: "4737", email: "fernanda.faturamento@torp.com", department: "Administrativo", lunchTime: "12:30-14:00" },
  { id: generateId(), name: "Tatiana (DP)", extension: "4728", email: "tatiana.guimaraes@torp.ind.br", department: "Administrativo", lunchTime: "12:30-13:30" },
  
  // COMERCIAL
  { id: generateId(), name: "Carlos Eduardo (Supervisor Opera√ß√µes)", extension: "4717", email: "carloseduardo.oliveira@torp.ind.br", department: "Comercial" },
  { id: generateId(), name: "Khendry", extension: "4714", email: "khendry.mendonca@torp.ind.br", department: "Comercial", lunchTime: "12:00-13:00" },
  { id: generateId(), name: "Marcus", extension: "4732", email: "marcos.teixeira@torp.ind.br", department: "Comercial", lunchTime: "11:00-12:00" },
  
  // CONTROLADORIA
  { id: generateId(), name: "Vin√≠cius", extension: "4705", email: "vinicius.reis@torp.ind.br", department: "Controladoria", lunchTime: "12:30-13:30" },
  
  // MARKETING
  { id: generateId(), name: "Alice", extension: "4718", email: "alice.abreu@torp.ind.br", department: "Marketing", lunchTime: "12:00-13:00" },
  
  // TI
  { id: generateId(), name: "Wesley Oliveira", extension: "4722", email: "wesley.oliveira@torp.ind.br", department: "TI", lunchTime: "12:30-13:30" },
  
  // COMPRAS/PREFEITURA
  { id: generateId(), name: "Felipe (Supervisor Opera√ß√µes)", extension: "4708", email: "felipe.marciano@torp.ind.br", department: "Compras/Prefeitura", lunchTime: "13:00-14:00" },
  
  // SALA DE CARTELA
  { id: generateId(), name: "Sala de Cartela", extension: "4709", email: "xxx", department: "Salas" },
];

export interface EmployeeFormData {
  name: string;
  extension: string;
  email: string;
  department: string;
  lunchTime?: string;
}

export const useEmployeeManager = () => {
  const [employees, setEmployees] = useState<Employee[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  // Fun√ß√£o para garantir que todos os funcion√°rios tenham IDs
  const ensureEmployeeIds = (employees: Employee[]): Employee[] => {
    return employees.map(emp => ({
      ...emp,
      id: emp.id || generateId()
    }));
  };

  // Carregar funcion√°rios do localStorage ou usar dados padr√£o
  useEffect(() => {
    try {
      console.log('[useEmployeeManager] üîç Verificando dados no localStorage...');
      const storedEmployees = localStorage.getItem(STORAGE_KEY);
      if (storedEmployees) {
        const parsed = JSON.parse(storedEmployees);
        const employeesWithIds = ensureEmployeeIds(parsed);
        console.log(`[useEmployeeManager] ‚úÖ Encontrados ${employeesWithIds.length} funcion√°rios no localStorage`);
        console.log('[useEmployeeManager] Primeiros 3 funcion√°rios:', employeesWithIds.slice(0, 3).map(emp => ({ name: emp.name, department: emp.department })));
        setEmployees(employeesWithIds);
        // Salvar de volta com IDs se necess√°rio
        if (employeesWithIds.some((emp, index) => emp.id !== parsed[index]?.id)) {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(employeesWithIds));
          console.log(`[useEmployeeManager] üíæ Salvos ${employeesWithIds.length} funcion√°rios no localStorage`);
        }
      } else {
        console.log('[useEmployeeManager] ‚ö†Ô∏è Nenhum dado encontrado no localStorage, usando dados padr√£o');
        const employeesWithIds = ensureEmployeeIds(DEFAULT_EMPLOYEES);
        setEmployees(employeesWithIds);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(employeesWithIds));
        console.log(`[useEmployeeManager] üíæ Salvos ${employeesWithIds.length} funcion√°rios padr√£o no localStorage`);
      }
    } catch (error) {
      console.error('[useEmployeeManager] ‚ùå Erro ao carregar funcion√°rios:', error);
      const employeesWithIds = ensureEmployeeIds(DEFAULT_EMPLOYEES);
      setEmployees(employeesWithIds);
    } finally {
      setIsLoading(false);
      console.log('[useEmployeeManager] üéâ Carregamento conclu√≠do');
    }
  }, []);

  // Salvar funcion√°rios no localStorage
  const saveEmployees = (newEmployees: Employee[]) => {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(newEmployees));
      setEmployees(newEmployees);
    } catch (error) {
      console.error('Erro ao salvar funcion√°rios:', error);
      toast({
        title: "‚ùå Erro ao Salvar",
        description: "N√£o foi poss√≠vel salvar as altera√ß√µes.",
        variant: "destructive",
      });
    }
  };

  // Adicionar novo funcion√°rio
  const addEmployee = (employeeData: EmployeeFormData): boolean => {
    try {
      // Verificar se o email j√° existe (se n√£o for 'xxx')
      if (employeeData.email !== 'xxx') {
        const emailExists = employees.some(emp => emp.email === employeeData.email);
        if (emailExists) {
          toast({
            title: "‚ùå Email j√° existe",
            description: `O email ${employeeData.email} j√° est√° sendo usado por outro funcion√°rio.`,
            variant: "destructive",
          });
          return false;
        }
      }

      const newEmployee: Employee = {
        id: generateId(),
        ...employeeData,
        lunchTime: employeeData.lunchTime || undefined,
      };

      const updatedEmployees = [...employees, newEmployee];
      saveEmployees(updatedEmployees);

      toast({
        title: "‚úÖ Funcion√°rio Adicionado",
        description: `${employeeData.name} foi adicionado com sucesso.`,
      });

      return true;
    } catch (error) {
      console.error('Erro ao adicionar funcion√°rio:', error);
      toast({
        title: "‚ùå Erro ao Adicionar",
        description: "N√£o foi poss√≠vel adicionar o funcion√°rio.",
        variant: "destructive",
      });
      return false;
    }
  };

  // Editar funcion√°rio existente
  const updateEmployee = (id: string, employeeData: EmployeeFormData): boolean => {
    try {
      const index = employees.findIndex(emp => emp.id === id);
      if (index === -1) {
        toast({
          title: "‚ùå Erro ao Atualizar",
          description: "Funcion√°rio n√£o encontrado.",
          variant: "destructive",
        });
        return false;
      }

      // Verificar se o email j√° existe (exceto para o pr√≥prio funcion√°rio e se n√£o for 'xxx')
      if (employeeData.email !== 'xxx') {
        const emailExists = employees.some(emp => 
          emp.id !== id && emp.email === employeeData.email
        );
        if (emailExists) {
          toast({
            title: "‚ùå Email j√° existe",
            description: `O email ${employeeData.email} j√° est√° sendo usado por outro funcion√°rio.`,
            variant: "destructive",
          });
          return false;
        }
      }

      const updatedEmployees = [...employees];
      updatedEmployees[index] = {
        ...updatedEmployees[index],
        ...employeeData,
        lunchTime: employeeData.lunchTime || undefined,
      };

      saveEmployees(updatedEmployees);

      toast({
        title: "‚úÖ Funcion√°rio Atualizado",
        description: `${employeeData.name} foi atualizado com sucesso.`,
      });

      return true;
    } catch (error) {
      console.error('Erro ao atualizar funcion√°rio:', error);
      toast({
        title: "‚ùå Erro ao Atualizar",
        description: "N√£o foi poss√≠vel atualizar o funcion√°rio.",
        variant: "destructive",
      });
      return false;
    }
  };

  // Remover funcion√°rio
  const removeEmployee = (id: string): boolean => {
    try {
      const employeeToRemove = employees.find(emp => emp.id === id);
      if (!employeeToRemove) {
        toast({
          title: "‚ùå Erro ao Remover",
          description: "Funcion√°rio n√£o encontrado.",
          variant: "destructive",
        });
        return false;
      }

      const updatedEmployees = employees.filter(emp => emp.id !== id);
      saveEmployees(updatedEmployees);

      toast({
        title: "‚úÖ Funcion√°rio Removido",
        description: `${employeeToRemove.name} foi removido com sucesso.`,
      });

      return true;
    } catch (error) {
      console.error('Erro ao remover funcion√°rio:', error);
      toast({
        title: "‚ùå Erro ao Remover",
        description: "N√£o foi poss√≠vel remover o funcion√°rio.",
        variant: "destructive",
      });
      return false;
    }
  };

  // Resetar para dados padr√£o
  const resetToDefault = () => {
    try {
      saveEmployees(DEFAULT_EMPLOYEES);
      toast({
        title: "‚úÖ Dados Resetados",
        description: "Lista de funcion√°rios foi resetada para os dados padr√£o.",
      });
    } catch (error) {
      console.error('Erro ao resetar funcion√°rios:', error);
      toast({
        title: "‚ùå Erro ao Resetar",
        description: "N√£o foi poss√≠vel resetar os dados.",
        variant: "destructive",
      });
    }
  };

  // Exportar dados
  const exportEmployees = (): string | null => {
    try {
      return JSON.stringify(employees, null, 2);
    } catch (error) {
      console.error('Erro ao exportar funcion√°rios:', error);
      return null;
    }
  };

  // Importar dados
  const importEmployees = (jsonData: string): boolean => {
    try {
      const importedEmployees = JSON.parse(jsonData);
      
      // Validar estrutura dos dados
      if (!Array.isArray(importedEmployees)) {
        throw new Error('Dados devem ser um array');
      }

      // Validar cada funcion√°rio
      for (const emp of importedEmployees) {
        if (!emp.name || !emp.extension || !emp.email || !emp.department) {
          throw new Error('Dados de funcion√°rio inv√°lidos');
        }
      }

      saveEmployees(importedEmployees);
      toast({
        title: "‚úÖ Dados Importados",
        description: `${importedEmployees.length} funcion√°rios foram importados com sucesso.`,
      });

      return true;
    } catch (error) {
      console.error('Erro ao importar funcion√°rios:', error);
      toast({
        title: "‚ùå Erro na Importa√ß√£o",
        description: "Arquivo inv√°lido ou corrompido.",
        variant: "destructive",
      });
      return false;
    }
  };

  // Obter departamentos √∫nicos
  const getDepartments = (): string[] => {
    const departments = employees.map(emp => emp.department);
    return [...new Set(departments)].sort();
  };

  return {
    employees,
    isLoading,
    addEmployee,
    updateEmployee,
    removeEmployee,
    resetToDefault,
    exportEmployees,
    importEmployees,
    getDepartments,
  };
};